name: Build Mesa for Adreno 725

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-mesa:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Mesa
      uses: actions/checkout@v4
      with:
        # 建议使用包含a7xx支持的分支
        repository: 'https://gitlab.freedesktop.org/mesa/mesa.git'
        ref: 'main'  # 或特定commit ID
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip python3-setuptools python3-wheel \
          meson ninja-build pkg-config \
          llvm-dev libllvm-ocaml-dev \
          libclang-dev clang \
          libdrm-dev libwayland-dev \
          libx11-dev libxext-dev libxdamage-dev libxcb-glx0-dev \
          python3-mako python3-ply \
          flex bison \
          crossbuild-essential-arm64
        
        pip3 install mako meson
    
    - name: Setup ARM64 toolchain
      run: |
        sudo dpkg --add-architecture arm64
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          pkg-config-aarch64-linux-gnu
        
        # 设置交叉编译环境变量
        echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
        echo "CXX=aarch64-linux-gnu-g++" >> $GITHUB_ENV
        echo "PKG_CONFIG=aarch64-linux-gnu-pkg-config" >> $GITHUB_ENV
    
    - name: Configure Mesa for Adreno 725
      run: |
        # 创建ARM64交叉编译文件
        cat > cross_file.txt << EOF
        [binaries]
        c = 'aarch64-linux-gnu-gcc'
        cpp = 'aarch64-linux-gnu-g++'
        ar = 'aarch64-linux-gnu-ar'
        strip = 'aarch64-linux-gnu-strip'
        pkgconfig = 'aarch64-linux-gnu-pkg-config'
        
        [host_machine]
        system = 'linux'
        cpu_family = 'aarch64'
        cpu = 'aarch64'
        endian = 'little'
        
        [properties]
        needs_exe_wrapper = true
        EOF
        
        # 配置Meson构建
        meson setup builddir/ \
          --cross-file cross_file.txt \
          --buildtype=release \
          -Dplatforms=x11,wayland \
          -Dgallium-drivers=zink,virgl \
          -Dvulkan-drivers=swrast,freedreno \
          -Dfreedreno-kmds=msm,drm \
          -Dllvm=enabled \
          -Dlto=false \  # 禁用LTO提高兼容性[^3^]
          -Dexplicit_pci_ids="0x7025" \  # Adreno 725 PCI ID
          -Db_lto=false \
          -Dcpp_rtti=false
    
    - name: Build Mesa
      run: |
        ninja -C builddir/
        
        # 打包
        cd builddir
        tar -czf mesa-adreno725-${GITHUB_RUN_NUMBER}.tar.gz \
          src/gallium/targets/libgl*.so* \
          src/amd/vulkan/libvulkan*.so* \
          src/freedreno/vulkan/libvulkan*.so*
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mesa-adreno725-build
        path: builddir/mesa-adreno725-*.tar.gz

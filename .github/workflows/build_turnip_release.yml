name: Build Mesa Turnip for A725

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARTIFACT: mesa-turnip-a725
      RELEASE_FILE: mesa-turnip-a725.tar.gz

    steps:

    - name: Checkout current repository
      uses: actions/checkout@v4

    - name: Clone Mesa
      run: |
        git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git mesa

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          ninja-build python3-mako python3-pip python3-setuptools \
          python3-wheel llvm clang lld meson cmake git pkg-config \
          libx11-dev libxext-dev libxdamage-dev libxfixes-dev \
          libdrm-dev libexpat1-dev zlib1g-dev elfutils libelf-dev

    - name: Create cross file
      run: |
        cat > aarch64-termux-glibc.txt <<EOF
[binaries]
c = 'clang'
cpp = 'clang++'
ar = 'llvm-ar'
strip = 'llvm-strip'
pkgconfig = 'pkg-config'

[host_machine]
system = 'linux'
cpu_family = 'aarch64'
cpu = 'aarch64'
endian = 'little'
EOF

    - name: Build Vulkan Loader
      run: |
        git clone --depth=1 https://github.com/KhronosGroup/Vulkan-Loader.git loader
        cd loader
        cmake -B build -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_INSTALL_PREFIX=/usr
        cmake --build build -j$(nproc)
        DESTDIR=../install cmake --install build

    - name: Build Mesa Turnip
      run: |
        meson setup build mesa/ \
          --cross-file aarch64-termux-glibc.txt \
          -Dbuildtype=release \
          -Dvulkan-drivers=freedreno \
          -Dgallium-drivers=[] \
          -Dplatforms=surfaceless \
          -Dfreedreno-kmds=kgsl \
          -Dfreedreno-targets=a7xx \
          -Dllvm=false \
          -Dglx=disabled \
          -Degl=disabled \
          -Dmicrosoft-clc=disabled \
          -Dbuild-tests=false

        meson compile -C build -j$(nproc)
        DESTDIR=install meson install -C build

    - name: Generate ICD file
      run: |
        mkdir -p install/usr/share/vulkan/icd.d
        cat > install/usr/share/vulkan/icd.d/turnip_a7xx.json <<EOF
{
    "ICD": {
        "library_path": "libvulkan_freedreno.so",
        "api_version": "1.3.275"
    }
}
EOF

    - name: Collect dependencies
      run: |
        mkdir -p install/usr/lib
        DRIVER=$(find install -name "libvulkan_freedreno.so*" | head -n 1)
        echo "Turnip driver: $DRIVER"
        ldd $DRIVER | grep "=>" | awk '{print $3}' | while read lib; do
            if [ -f "$lib" ]; then
                echo "Copy dependency: $lib"
                cp -v "$lib" install/usr/lib/
            fi
        done

    - name: Pack tarball
      run: |
        cd install
        tar -czvf ../${RELEASE_FILE} .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT }}
        path: ${{ env.RELEASE_FILE }}

    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: ${{ env.RELEASE_FILE }}

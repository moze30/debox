name: Build Mesa for Adreno 725 (Cross Compile)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-cross-arm:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install cross-compilation tools
      run: |
        sudo apt update
        sudo apt install -y \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          python3-pip \
          pkg-config \
          ninja-build

    - name: Install and upgrade Meson
      run: |
        pip3 install --upgrade pip
        pip3 install meson
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        meson --version

    - name: Clone Mesa source
      run: |
        git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git
        cd mesa
        echo "Mesa version: $(git describe --tags || git rev-parse --short HEAD)"

    - name: Create cross-compilation configuration
      run: |
        cd mesa
        cat > aarch64-cross.txt << 'EOF'
        [binaries]
        c = 'aarch64-linux-gnu-gcc'
        cpp = 'aarch64-linux-gnu-g++'
        ar = 'aarch64-linux-gnu-ar'
        strip = 'aarch64-linux-gnu-strip'
        pkg-config = 'pkg-config'
        
        [host_machine]
        system = 'linux'
        cpu_family = 'aarch64'
        cpu = 'aarch64'
        endian = 'little'
        EOF

    - name: Configure Mesa for Adreno 725 (Simplified)
      run: |
        cd mesa
        meson setup builddir \
          --cross-file aarch64-cross.txt \
          -Dprefix=/usr/local \
          -Dgallium-drivers=freedreno \
          -Dvulkan-drivers=freedreno \
          -Dfreedreno-kmd=kgsl \
          -Dglx=disabled \
          -Degl=enabled \
          -Dgles2=enabled \
          -Dplatforms=surfaceless \
          -Dbuildtype=release \
          -Dstrip=true \
          -Dllvm=disabled \
          -Dshared-glapi=enabled

    - name: Build Mesa
      run: |
        cd mesa
        echo "Starting cross compilation with Meson $(meson --version)..."
        ninja -C builddir -j2  # 使用较少的线程避免内存不足
        echo "Cross compilation completed!"

    - name: Verify build results
      run: |
        cd mesa
        echo "Generated libraries:"
        find builddir -name "*.so*" | sort

    - name: Create minimal package
      run: |
        cd mesa
        mkdir -p ../mesa-cross-package/lib
        
        # 只复制最重要的库文件
        find builddir -name "libEGL.so*" -exec cp {} ../mesa-cross-package/lib/ \;
        find builddir -name "libGLESv2.so*" -exec cp {} ../mesa-cross-package/lib/ \;
        find builddir -name "libvulkan_*freedreno.so*" -exec cp {} ../mesa-cross-package/lib/ \; 2>/dev/null || true
        find builddir -name "libfreedreno.so*" -exec cp {} ../mesa-cross-package/lib/ \; 2>/dev/null || true
        
        # 创建简单说明
        echo "# Mesa for Adreno 725 (Cross Compiled)" > ../mesa-cross-package/README.md
        echo "Cross compiled for AArch64 on $(date)" >> ../mesa-cross-package/README.md

    - name: Create release archive
      run: |
        tar -czf mesa-adreno725-cross-aarch64.tar.gz mesa-cross-package
        ls -lh mesa-adreno725-cross-aarch64.tar.gz

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mesa-adreno725-cross-build
        path: mesa-adreno725-cross-aarch64.tar.gz

    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: mesa-cross-${{ github.run_number }}
        name: Mesa Cross-compiled for Adreno 725 Build ${{ github.run_number }}
        body: |
          Cross-compiled Mesa for Adreno 725 GPU
          
          ## Build Information
          - Architecture: AArch64 (ARM64) - Cross Compiled
          - Target GPU: Adreno 725
          - Build Type: Release
          - Build Date: $(date)
          
          ## Included Components
          - Freedreno driver for Adreno GPUs
          - EGL support
          - GLESv2 support
          - Vulkan support (if available)
          
          ## Usage
          Extract and copy libraries to your ARM device.
        files: mesa-adreno725-cross-aarch64.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

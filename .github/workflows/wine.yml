name: 编译 Wine WOW64（干净版）

on:
  workflow_dispatch:

jobs:
  build-wine:
    runs-on: ubuntu-24.04

    steps:
    - name: 拉取仓库
      uses: actions/checkout@v4

    - name: 安装 Wine 编译依赖
      run: |
        sudo dpkg --add-architecture i386
        sudo apt update
        sudo apt install -y \
          build-essential \
          gcc-multilib g++-multilib \
          flex bison \
          git \
          autoconf automake libtool \
          pkg-config \
          gettext \
          ca-certificates \
          wget xz-utils \
          libx11-dev libx11-dev:i386 \
          libxext-dev libxext-dev:i386 \
          libxrandr-dev libxrandr-dev:i386 \
          libxinerama-dev libxinerama-dev:i386 \
          libxcursor-dev libxcursor-dev:i386 \
          libxi-dev libxi-dev:i386 \
          libxcomposite-dev libxcomposite-dev:i386 \
          libxdamage-dev libxdamage-dev:i386 \
          libxfixes-dev libxfixes-dev:i386 \
          libfreetype6-dev libfreetype6-dev:i386 \
          libfontconfig1-dev libfontconfig1-dev:i386 \
          libgl-dev libgl-dev:i386 \
          libasound2-dev libasound2-dev:i386 \
          libpulse-dev libpulse-dev:i386 \
          libdbus-1-dev libdbus-1-dev:i386 \
          libudev-dev libudev-dev:i386

    - name: 克隆 Wine 源码
      run: |
        git clone https://github.com/wine-mirror/wine.git
        cd wine
        git checkout wine-11.0

    - name: 构建 32 位 Wine（i386）
      run: |
        cd wine
        mkdir build32
        cd build32
        ../configure \
          --disable-tests \
          --prefix=/opt/wine-wow64
        make -j$(nproc)

    - name: 构建 64 位 Wine + WOW64
      run: |
        cd wine
        mkdir build64
        cd build64
        ../configure \
          --enable-win64 \
          --enable-wow64 \
          --with-wine32=../build32 \
          --disable-tests \
          --prefix=/opt/wine-wow64
        make -j$(nproc)

    - name: 安装 Wine（DESTDIR 打包）
      run: |
        cd wine/build64
        mkdir -p package
        make install DESTDIR=$PWD/package

    - name: 验证 WOW64
      run: |
        cd wine/build64/package
        file opt/wine-wow64/bin/wine
        file opt/wine-wow64/bin/wine64 || true

    - name: 打包 Wine WOW64
      run: |
        cd wine/build64/package
        tar -cJf wine-wow64.tar.xz *

    - name: 上传编译产物
      uses: actions/upload-artifact@v4
      with:
        name: wine-wow64
        path: wine/build64/package/wine-wow64.tar.xz

name: 编译 Wine WOW64（官方双构建，稳定版）

on:
  workflow_dispatch:

env:
  WINE_VERSION: wine-11.0
  WINE_PREFIX: /opt/wine-wow64

jobs:
  build-wow64:
    name: 编译 WOW64 Wine
    runs-on: ubuntu-24.04
    timeout-minutes: 180

    steps:
      - name: 拉取仓库
        uses: actions/checkout@v4

      - name: 安装编译依赖
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update

          sudo apt install -y \
            build-essential \
            git \
            pkg-config \
            autoconf \
            bison \
            flex \
            gettext \
            gcc-multilib \
            g++-multilib \
            libx11-dev libx11-dev:i386 \
            libxext-dev libxext-dev:i386 \
            libxinerama-dev libxinerama-dev:i386 \
            libxcursor-dev libxcursor-dev:i386 \
            libxrender-dev libxrender-dev:i386 \
            libxrandr-dev libxrandr-dev:i386 \
            libxi-dev libxi-dev:i386 \
            libfreetype-dev libfreetype-dev:i386 \
            libfontconfig1-dev libfontconfig1-dev:i386 \
            libgl-dev libgl-dev:i386 \
            libvulkan-dev libvulkan-dev:i386 \
            libpulse-dev libpulse-dev:i386 \
            libasound2-dev libasound2-dev:i386 \
            libdbus-1-dev libdbus-1-dev:i386 \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            mingw-w64 \
            python3

      - name: 克隆 Wine 源码
        run: |
          git clone https://github.com/wine-mirror/wine.git
          cd wine
          git checkout ${WINE_VERSION}

      - name: 构建 32 位 Wine（WOW64 基础）
        run: |
          set -e
          cd wine
          mkdir build32
          cd build32

          ../configure \
            --prefix=${WINE_PREFIX} \
            --enable-win32 \
            --disable-tests

          make -j$(nproc)
          make install

      - name: 构建 64 位 Wine（WOW64 主体）
        run: |
          set -e
          cd wine
          mkdir build64
          cd build64

          ../configure \
            --prefix=${WINE_PREFIX} \
            --enable-win64 \
            --with-wine32=../build32 \
            --disable-tests

          make -j$(nproc)
          make install

      - name: 验证 Wine 是否真实生成（关键）
        run: |
          ls -lh ${WINE_PREFIX}/bin
          file ${WINE_PREFIX}/bin/wine
          file ${WINE_PREFIX}/bin/wineserver
          ${WINE_PREFIX}/bin/wine --version || true

      - name: 打包 Wine WOW64
        run: |
          mkdir -p package
          cp -r ${WINE_PREFIX} package/wine-wow64
          tar -cJf wine-wow64.tar.xz -C package wine-wow64
          ls -lh wine-wow64.tar.xz

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: wine-wow64
          path: wine-wow64.tar.xz

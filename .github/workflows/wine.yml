name: 编译 Wine WOW64（GStreamer / 无 unwind）

on:
  workflow_dispatch:

jobs:
  build-wine-wow64:
    runs-on: ubuntu-24.04

    steps:
    - name: 拉取仓库
      uses: actions/checkout@v4

    - name: 启用 i386 架构
      run: |
        sudo dpkg --add-architecture i386
        sudo apt update

    - name: 安装编译依赖
      run: |
        sudo apt install -y \
          build-essential \
          gcc-multilib g++-multilib \
          flex bison \
          git \
          autoconf automake libtool \
          pkg-config \
          gettext \
          libx11-dev libx11-dev:i386 \
          libxext-dev libxext-dev:i386 \
          libxrandr-dev libxrandr-dev:i386 \
          libxinerama-dev libxinerama-dev:i386 \
          libxcursor-dev libxcursor-dev:i386 \
          libxi-dev libxi-dev:i386 \
          libxcomposite-dev libxcomposite-dev:i386 \
          libxdamage-dev libxdamage-dev:i386 \
          libxfixes-dev libxfixes-dev:i386 \
          libfreetype6-dev libfreetype6-dev:i386 \
          libfontconfig1-dev libfontconfig1-dev:i386 \
          libgl-dev libgl-dev:i386 \
          libasound2-dev libasound2-dev:i386 \
          libpulse-dev libpulse-dev:i386 \
          libdbus-1-dev \
          libudev-dev \
          libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev \
          libgstreamer-plugins-good1.0-dev \
          libvulkan-dev libvulkan-dev:i386 \
          mingw-w64 \
          ca-certificates \
          wget xz-utils

    - name: 克隆 Wine 源码
      run: |
        git clone https://github.com/wine-mirror/wine.git
        cd wine
        git checkout wine-11.0

    - name: 生成 configure 脚本
      run: |
        cd wine
        ./tools/make_makefiles
        autoreconf -fiv

    # ======================
    # build64（核心）
    # ======================
    - name: 配置 Wine64
      run: |
        cd wine
        mkdir build64
        cd build64
        ../configure \
          --enable-win64 \
          --prefix=/root/wine-wow64 \
          --disable-tests \
          --disable-winemenubuilder \
          --disable-win16 \
          --without-unwind

    - name: 编译 Wine64
      run: |
        cd wine/build64
        make -j$(nproc)

    # ======================
    # build32（WOW64 glue）
    # ======================
    - name: 配置 Wine32（WOW64）
      run: |
        cd wine
        mkdir build32
        cd build32
        ../configure \
          --with-wine64=../build64 \
          --prefix=/root/wine-wow64 \
          --disable-tests \
          --disable-win16 \
          --without-unwind

    - name: 编译 Wine32
      run: |
        cd wine/build32
        make -j$(nproc)

    # ======================
    # 安装（只 install 一次）
    # ======================
    - name: 安全安装 Wine WOW64（DESTDIR）
      run: |
        cd wine/build64
        make install DESTDIR=$PWD/package

    - name: 检查关键产物
      run: |
        cd wine/build64/package
        ls -l root/wine-wow64/bin
        file root/wine-wow64/bin/wine
        file root/wine-wow64/bin/winecfg
        file root/wine-wow64/bin/wineserver

    - name: 打包 Wine WOW64
      run: |
        cd wine/build64/package
        tar -cJf wine-wow64.tar.xz root

    - name: 上传编译产物
      uses: actions/upload-artifact@v4
      with:
        name: wine-wow64
        path: wine/build64/package/wine-wow64.tar.xz

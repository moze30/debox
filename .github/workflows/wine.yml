name: 编译 Proton WOW64（Kron4ek 构建体系）

on:
  workflow_dispatch:

jobs:
  build-Proton-WOW64:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    steps:
      - name: 拉取当前仓库
        uses: actions/checkout@v4

      - name: 安装宿主构建依赖
        run: |
          sudo apt update
          sudo apt install -y \
            debootstrap \
            sudo \
            git \
            ca-certificates \
            gnupg \
            wget \
            xz-utils \
            tar \
            bzip2 \
            rsync \
            build-essential \
            pkg-config \
            qemu-user-static \
            binfmt-support

      - name: 克隆 Kron4ek Wine-Builds
        run: |
          git clone https://github.com/Kron4ek/Wine-Builds.git
          cd Wine-Builds
          git submodule update --init --recursive

      - name: 创建 Ubuntu 构建 rootfs（一次即可）
        run: |
          cd Wine-Builds
          chmod +x create_ubuntu_bootstraps.sh
          sudo ./create_ubuntu_bootstraps.sh

      - name: 准备 Proton Wine 源码
        run: |
          cd Wine-Builds
          mkdir -p sources
          cd sources
          git clone https://github.com/ValveSoftware/wine.git proton-wine
          cd proton-wine
          git checkout proton-10.0

      - name: 使用 Kron4ek 脚本构建 Proton WOW64
        env:
          WINE_SOURCE_DIR: ${{ github.workspace }}/Wine-Builds/sources/proton-wine
        run: |
          cd Wine-Builds
          chmod +x build_wine.sh
          sudo ./build_wine.sh

      - name: 打包构建产物
        run: |
          cd Wine-Builds
          mkdir -p output
          cp -r builds/* output/
          tar -cJf proton-wow64.tar.xz output

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: proton-wow64
          path: Wine-Builds/proton-wow64.tar.xz

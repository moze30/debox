name: ç¨³å®šç‰ˆ Mesa (aarch64, Manual Build 25.0.0)

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: æ˜¾ç¤ºæ„å»ºç¯å¢ƒä¿¡æ¯
        run: |
          echo "ğŸ—ï¸ æ„å»ºç¯å¢ƒ:"
          lsb_release -a || true
          uname -a
          echo "CPU ä¿¡æ¯:"
          lscpu | grep -E 'Model name|Architecture|CPU MHz|Core'

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£… Mesa æ„å»ºä¾èµ–..."
          sudo sed -i "s/^Types: deb$/Types: deb deb-src/" /etc/apt/sources.list.d/ubuntu.sources
          sudo apt update
          
          # 1. ä¿ç•™äº†ä¿®å¤ X11 æŠ¥é”™çš„ libxfixes-dev libxdamage-dev
          # 2. æ–°å¢äº† valgrind (ä¸ºäº†æ”¯æŒæ‚¨å‚æ•°ä¸­çš„ -Dvalgrind=enabled)
          sudo apt install -y glslang-tools libxrandr-dev libxxf86vm-dev libxcb-shm0-dev libxcb-glx0-dev \
              libxext-dev llvm-19 libx11-dev libx11-xcb-dev libxcb1-dev libxcb-dri3-dev libxcb-present-dev \
              libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev libxshmfence-dev libdrm-dev \
              libgbm-dev libegl1-mesa-dev libexpat1-dev libwayland-dev python3-pip \
              libxfixes-dev libxdamage-dev valgrind
              
          pip3 install --user meson ninja mako
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å…‹éš† Mesa ä»“åº“ (ç‰ˆæœ¬ 25.0.0)
        run: |
          echo "ğŸ“¥ å…‹éš† Mesa ä»“åº“..."
          git clone https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          
          echo "ğŸ”€ åˆ‡æ¢åˆ°ç‰ˆæœ¬ mesa-25.0.0..."
          git fetch --tags
          git checkout mesa-25.0.0

          echo "ğŸ”§ è‡ªå®šä¹‰å“ç‰Œ: Turnip â†’ Qualcomm Snapdragon"
          sed -i 's/Turnip Adreno (TM) %s%s/Qualcomm Snapdragon Adreno (TM) %s%s/' src/freedreno/vulkan/tu_device.cc
          sed -i 's/"turnip Mesa driver"/"Qualcomm Snapdragon Driver"/' src/freedreno/vulkan/tu_device.cc
          sed -i 's/"Mesa " PACKAGE_VERSION MESA_GIT_SHA1/"Qualcomm Snapdragon " PACKAGE_VERSION MESA_GIT_SHA1/' src/freedreno/vulkan/tu_device.cc

          echo "ğŸ§¾ å½“å‰æäº¤ä¿¡æ¯:"
          git log -1 --oneline --decorate

      - name: æ„å»º Mesa
        run: |
          cd mesa
          BUILD_START=$(date +%s)
          # åˆ›å»ºå®‰è£…ç›®å½•ï¼Œç¡®ä¿ packaging æ­¥éª¤èƒ½æ‰¾åˆ°æ–‡ä»¶
          sudo mkdir -p /data/data/com.termux/files/usr/glibc
          sudo chmod 777 -R /data

          echo "âš™ï¸ ä½¿ç”¨æ–°å‚æ•°é…ç½®æ„å»º..."
          # ä½¿ç”¨æ‚¨æŒ‡å®šçš„ç›®å½•å build-freedreno
          mkdir -p build-freedreno
          
          # === ä½¿ç”¨æ‚¨æŒ‡å®šçš„æ–°å‚æ•° ===
          # ä¿ç•™ prefix å’Œ libdir æ˜¯ä¸ºäº†è®© install æ­¥éª¤å®‰è£…åˆ°æ­£ç¡®ä½ç½®ä¾›æ‰“åŒ…
          meson setup build-freedreno \
            --libdir=lib \
            -Dprefix=/data/data/com.termux/files/usr/glibc \
            -Dbuildtype=release \
            -Dplatforms=x11 \
            -Dgallium-drivers= \
            -Dvulkan-drivers=freedreno \
            -Dlibunwind=disabled \
            -Dmicrosoft-clc=disabled \
            -Dvalgrind=enabled \
            -Dfreedreno-kmds=wsl,kgsl,msm \
            -Dvideo-codecs=all \
            -Dvulkan-beta=true

          echo "ğŸ§± å¼€å§‹ç¼–è¯‘..."
          # æ³¨æ„ï¼šè¿™é‡Œç›®å½•æ”¹æˆäº† build-freedreno
          ninja -C build-freedreno -j$(nproc)
          
          echo "ğŸ“¦ å®‰è£…åˆ° glibc ç›®å½•..."
          ninja -C build-freedreno install

          BUILD_END=$(date +%s)
          DURATION=$((BUILD_END - BUILD_START))
          echo "ğŸ•’ æ„å»ºè€—æ—¶: ${DURATION} ç§’"

          VERSION=$(cat VERSION)
          GIT_HASH=$(git rev-parse --short HEAD)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "GIT_HASH=${GIT_HASH}" >> $GITHUB_ENV

      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ… Mesa äº§ç‰©..."
          cd mesa
          PACK_START=$(date +%s)

          # === 1ï¸âƒ£ Vulkan é©±åŠ¨æœ€å°åŒ… ===
          TAR_NAME="termux-glibc-mesa-${VERSION}-aarch64.tar.gz"
          # ç›®å½•ä¿®æ­£ä¸º build-freedreno
          tar -czvf "../${TAR_NAME}" -C build-freedreno/src/freedreno/vulkan libvulkan_freedreno.so

          # === 2ï¸âƒ£ å®Œæ•´ glibc Mesa ç¯å¢ƒåŒ… ===
          FULL_TAR="glibc-mesa-${VERSION}-aarch64.tar.gz"
          tar -czvf "../${FULL_TAR}" -C /data/data/com.termux/files/usr glibc

          # === 3ï¸âƒ£ ç”Ÿæˆ SHA256 æ ¡éªŒæ–‡ä»¶ ===
          cd ..
          sha256sum "${TAR_NAME}" > "${TAR_NAME}.sha256"
          sha256sum "${FULL_TAR}" > "${FULL_TAR}.sha256"

          PACK_END=$(date +%s)
          PACK_DUR=$((PACK_END - PACK_START))
          echo "ğŸ•’ æ‰“åŒ…è€—æ—¶: ${PACK_DUR} ç§’"

          echo "ğŸ“‚ è¾“å‡ºæ–‡ä»¶:"
          du -h ${TAR_NAME} ${FULL_TAR} | sort -h
          echo "TAR_NAME=${TAR_NAME}" >> $GITHUB_ENV
          echo "FULL_TAR=${FULL_TAR}" >> $GITHUB_ENV

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: mesa-artifacts-${{ env.VERSION }}-aarch64
          path: |
            ${{ env.TAR_NAME }}
            ${{ env.FULL_TAR }}
            ${{ env.TAR_NAME }}.sha256
            ${{ env.FULL_TAR }}.sha256

      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: mesa-${{ env.VERSION }}-manual
          name: Mesa ${{ env.VERSION }} (Manual Build)
          body: |
            ğŸ”§ **Mesa æ‰‹åŠ¨æ„å»ºä¿¡æ¯**
            - ğŸ§± ç‰ˆæœ¬: **${{ env.VERSION }}**
            - ğŸ’¡ æäº¤: `${{ env.GIT_HASH }}`
            - âš™ï¸ å‚æ•°: `platforms=x11`, `vulkan=freedreno`, `gallium=`
            - ğŸ“¦ äº§ç‰©åˆ—è¡¨:
              - `${{ env.TAR_NAME }}`
              - `${{ env.FULL_TAR }}`
          files: |
            ${{ env.TAR_NAME }}
            ${{ env.FULL_TAR }}
            ${{ env.TAR_NAME }}.sha256
            ${{ env.FULL_TAR }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡ºæ€»ç»“ä¿¡æ¯
        run: |
          echo "âœ… Mesa æ„å»ºä¸æ‰“åŒ…å®Œæˆ"
          echo "ğŸ”– Mesa ç‰ˆæœ¬: ${{ env.VERSION }}"
          echo "ğŸ’¾ æäº¤å“ˆå¸Œ: ${{ env.GIT_HASH }}"
          echo "ğŸ“¦ æ–‡ä»¶:"
          ls -lh ${{ env.TAR_NAME }}* ${{ env.FULL_TAR }}*
          echo "ğŸ“… æ„å»ºæ—¶é—´: $(date)"
          uname -a

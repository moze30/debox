Name: ç¨³å®šç‰ˆ Mesa (aarch64, Ubuntu 22.04 Build)

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  build:
    # [æ›´æ”¹ 1] åˆ‡æ¢åˆ° Ubuntu 22.04 ARM ç¯å¢ƒ
    runs-on: ubuntu-22.04-arm

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: æ˜¾ç¤ºæ„å»ºç¯å¢ƒä¿¡æ¯
        run: |
          echo "ğŸ—ï¸ æ„å»ºç¯å¢ƒ:"
          lsb_release -a || true
          uname -a
          echo "CPU ä¿¡æ¯:"
          lscpu | grep -E 'Model name|Architecture|CPU MHz|Core'

      - name: å®‰è£…ä¾èµ– (é€‚é… Ubuntu 22.04)
        run: |
          echo "ğŸ“¦ é…ç½® Ubuntu 22.04 æºä¸ LLVM..."
          
          # [æ›´æ”¹ 2] é€‚é… Ubuntu 22.04 çš„æºé…ç½®æ–¹å¼ (sources.list)
          # å¼€å¯æºç ä»“åº“ (deb-src)
          sudo sed -Ei 's/^# deb-src /deb-src /' /etc/apt/sources.list
          sudo apt update

          # [æ›´æ”¹ 3] å®‰è£… LLVM 19 (Ubuntu 22.04 é»˜è®¤åªæœ‰æ—§ç‰ˆ LLVMï¼Œéœ€æ‰‹åŠ¨æ·»åŠ æº)
          echo "â¬‡ï¸ å®‰è£… LLVM 19..."
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 19
          
          echo "ğŸ“¦ å®‰è£… Mesa æ„å»ºä¾èµ–..."
          # æ³¨æ„: llvm-19 å·²ç»åœ¨ä¸Šé¢é€šè¿‡è„šæœ¬å®‰è£…äº†ï¼Œè¿™é‡Œä¿ç•™æ˜¯ä¸ºäº†ç¡®ä¿ä¾èµ–å®Œæ•´
          # æ·»åŠ äº† libxfixes-dev å’Œ libxdamage-dev
          sudo apt install -y glslang-tools libxrandr-dev libxxf86vm-dev libxcb-shm0-dev libxcb-glx0-dev \
              libxext-dev libx11-dev libx11-xcb-dev libxcb1-dev libxcb-dri3-dev libxcb-present-dev \
              libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev libxshmfence-dev libdrm-dev \
              libgbm-dev libegl1-mesa-dev libexpat1-dev libwayland-dev python3-pip \
              libxfixes-dev libxdamage-dev \
              libllvm19 llvm-19-dev llvm-19
              
          pip3 install --user meson ninja mako
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å…‹éš† Mesa ä»“åº“ (ç‰ˆæœ¬ 25.0.0)
        run: |
          echo "ğŸ“¥ å…‹éš† Mesa ä»“åº“..."
          git clone https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          
          echo "ğŸ”€ åˆ‡æ¢åˆ°ç‰ˆæœ¬ mesa-25.0.0..."
          git fetch --tags
          git checkout mesa-25.0.0

          echo "ğŸ”§ è‡ªå®šä¹‰å“ç‰Œ: Turnip â†’ Qualcomm Snapdragon"
          sed -i 's/Turnip Adreno (TM) %s%s/Qualcomm Snapdragon Adreno (TM) %s%s/' src/freedreno/vulkan/tu_device.cc
          sed -i 's/"turnip Mesa driver"/"Qualcomm Snapdragon Driver"/' src/freedreno/vulkan/tu_device.cc
          sed -i 's/"Mesa " PACKAGE_VERSION MESA_GIT_SHA1/"Qualcomm Snapdragon " PACKAGE_VERSION MESA_GIT_SHA1/' src/freedreno/vulkan/tu_device.cc

          echo "ğŸ§¾ å½“å‰æäº¤ä¿¡æ¯:"
          git log -1 --oneline --decorate

      - name: æ„å»º Mesa
        run: |
          cd mesa
          BUILD_START=$(date +%s)
          sudo mkdir -p /data/data/com.termux/files/usr/glibc
          sudo chmod 777 -R /data

          echo "âš™ï¸ ä½¿ç”¨ Meson é…ç½®æ„å»º..."
          mkdir -p builddir
          
          # ç¡®ä¿ä½¿ç”¨ LLVM 19 çš„ config
          export LLVM_CONFIG=/usr/lib/llvm-19/bin/llvm-config

          meson setup builddir \
            --libdir=lib \
            -Dprefix=/data/data/com.termux/files/usr/glibc \
            -Dbuildtype=release \
            -Doptimization=3 \
            -Db_lto=true \
            -Dplatforms=x11 \
            -Degl-native-platform=x11 \
            -Dglx=dri \
            -Dglx-direct=true \
            -Dopengl=true \
            -Dgles1=enabled \
            -Dgles2=enabled \
            -Dglvnd=disabled \
            -Degl=enabled \
            -Dllvm=enabled \
            -Dshared-llvm=enabled \
            -Dshader-cache=enabled \
            -Dxlib-lease=enabled \
            -Dvulkan-beta=true \
            -Dlibunwind=disabled \
            -Dvalgrind=disabled \
            -Dmicrosoft-clc=disabled \
            -Dgallium-rusticl=false \
            -Dgallium-extra-hud=true \
            -Dgallium-drivers=zink,freedreno,llvmpipe,softpipe \
            -Dgallium-rusticl-enable-drivers=freedreno \
            -Dshader-cache-default=true \
            -Dvulkan-drivers=freedreno,swrast \
            -Dfreedreno-kmds=msm,kgsl \
            -Dvideo-codecs=all \
            -Dgbm=enabled \
            -Dtools=drm-shim,freedreno

          echo "ğŸ§± å¼€å§‹ç¼–è¯‘..."
          ninja -C builddir -j$(nproc)
          echo "ğŸ“¦ å®‰è£…åˆ° glibc ç›®å½•..."
          ninja -C builddir install

          BUILD_END=$(date +%s)
          DURATION=$((BUILD_END - BUILD_START))
          echo "ğŸ•’ æ„å»ºè€—æ—¶: ${DURATION} ç§’"

          VERSION=$(cat VERSION)
          GIT_HASH=$(git rev-parse --short HEAD)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "GIT_HASH=${GIT_HASH}" >> $GITHUB_ENV

      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ… Mesa äº§ç‰©..."
          cd mesa
          PACK_START=$(date +%s)

          # === 1ï¸âƒ£ Vulkan é©±åŠ¨æœ€å°åŒ… ===
          TAR_NAME="termux-glibc-mesa-${VERSION}-aarch64.tar.gz"
          tar -czvf "../${TAR_NAME}" -C builddir/src/freedreno/vulkan libvulkan_freedreno.so

          # === 2ï¸âƒ£ å®Œæ•´ glibc Mesa ç¯å¢ƒåŒ… ===
          FULL_TAR="glibc-mesa-${VERSION}-aarch64.tar.gz"
          tar -czvf "../${FULL_TAR}" -C /data/data/com.termux/files/usr glibc

          # === 3ï¸âƒ£ ç”Ÿæˆ SHA256 æ ¡éªŒæ–‡ä»¶ ===
          cd ..
          sha256sum "${TAR_NAME}" > "${TAR_NAME}.sha256"
          sha256sum "${FULL_TAR}" > "${FULL_TAR}.sha256"

          PACK_END=$(date +%s)
          PACK_DUR=$((PACK_END - PACK_START))
          echo "ğŸ•’ æ‰“åŒ…è€—æ—¶: ${PACK_DUR} ç§’"

          echo "ğŸ“‚ è¾“å‡ºæ–‡ä»¶:"
          du -h ${TAR_NAME} ${FULL_TAR} | sort -h
          echo "TAR_NAME=${TAR_NAME}" >> $GITHUB_ENV
          echo "FULL_TAR=${FULL_TAR}" >> $GITHUB_ENV

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: mesa-artifacts-${{ env.VERSION }}-aarch64
          path: |
            ${{ env.TAR_NAME }}
            ${{ env.FULL_TAR }}
            ${{ env.TAR_NAME }}.sha256
            ${{ env.FULL_TAR }}.sha256

      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: mesa-${{ env.VERSION }}-manual-u22
          name: Mesa ${{ env.VERSION }} (Manual Build Ubuntu 22.04)
          body: |
            ğŸ”§ **Mesa æ‰‹åŠ¨æ„å»ºä¿¡æ¯ (Ubuntu 22.04)**
            - ğŸ§± ç‰ˆæœ¬: **${{ env.VERSION }}**
            - ğŸ’¡ æäº¤: `${{ env.GIT_HASH }}`
            - ğŸ§ ç³»ç»Ÿ: Ubuntu 22.04 LTS (LLVM 19)
            - ğŸ“¦ äº§ç‰©åˆ—è¡¨:
              - `${{ env.TAR_NAME }}`
              - `${{ env.FULL_TAR }}`
          files: |
            ${{ env.TAR_NAME }}
            ${{ env.FULL_TAR }}
            ${{ env.TAR_NAME }}.sha256
            ${{ env.FULL_TAR }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡ºæ€»ç»“ä¿¡æ¯
        run: |
          echo "âœ… Mesa æ„å»ºä¸æ‰“åŒ…å®Œæˆ"
          echo "ğŸ”– Mesa ç‰ˆæœ¬: ${{ env.VERSION }}"
          echo "ğŸ’¾ æäº¤å“ˆå¸Œ: ${{ env.GIT_HASH }}"
          echo "ğŸ“¦ æ–‡ä»¶:"
          ls -lh ${{ env.TAR_NAME }}* ${{ env.FULL_TAR }}*
          echo "ğŸ“… æ„å»ºæ—¶é—´: $(date)"
          uname -a

name: Build Mesa Turnip for Adreno 725 (Auto Release)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      MESA_REPO: mesa3d/mesa
      ARTIFACT: mesa-turnip-a725
      RELEASE_FILE: mesa-turnip-a725.tar.gz

    steps:
    - name: Checkout Mesa
      uses: actions/checkout@v4
      with:
        repository: ${{ env.MESA_REPO }}
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential meson ninja-build cmake git python3-mako pkg-config \
          bison flex python3-jinja2 python3-ply \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          crossbuild-essential-arm64

    - name: Create cross file for aarch64 (glibc)
      run: |
        cat > aarch64-termux-glibc.txt <<'EOF'
        [binaries]
        c = 'aarch64-linux-gnu-gcc'
        cpp = 'aarch64-linux-gnu-g++'
        ar = 'aarch64-linux-gnu-ar'
        strip = 'aarch64-linux-gnu-strip'

        [host_machine]
        system = 'linux'
        cpu_family = 'aarch64'
        cpu = 'armv8'
        endian = 'little'

        [properties]
        needs_exe_wrapper = true
        EOF

    - name: Configure Mesa (Turnip only, optimized for A7xx)
      run: |
        meson setup build \
          --cross-file aarch64-termux-glibc.txt \
          -Dvulkan-drivers=freedreno \
          -Dgallium-drivers=[] \
          -Dplatforms=surfaceless \
          -Dfreedreno-kmds=kgsl \
          -Dfreedreno-targets=a7xx \
          -Dllvm=false \
          -Dglx=disabled \
          -Degl=disabled \
          -Dmicrosoft-clc=disabled \
          -Dbuild-tests=false

    - name: Build Mesa Turnip
      run: ninja -C build

    - name: Package tar.gz
      run: |
        mkdir -p output
        cp build/src/freedreno/vulkan/libvulkan_freedreno.so output/
        cat > output/turnip.json <<EOF
        {
          "file_format_version": "1.0.0",
          "ICD": {
            "library_path": "libvulkan_freedreno.so",
            "api_version": "1.3.0"
          }
        }
        EOF
        tar -czvf ${{ env.RELEASE_FILE }} -C output .

    - name: Upload artifact (for debug)
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT }}
        path: ${{ env.RELEASE_FILE }}

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: ${{ env.RELEASE_FILE }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Build Mesa for Adreno 725 (Native ARM)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-native-arm:
    # 使用自托管的ARM64设备
    runs-on: [self-hosted, ARM64]
    
    steps:
    - name: Clean workspace
      run: |
        rm -rf *
        
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update system and install dependencies
      run: |
        # 检查系统信息
        uname -a
        lscpu
        
        # 更新包管理器
        if command -v apt &> /dev/null; then
          sudo apt update
          sudo apt install -y \
            meson \
            ninja-build \
            python3-pip \
            pkg-config \
            gcc \
            g++ \
            libdrm-dev \
            libx11-dev \
            libxext-dev \
            libxfixes-dev \
            libxcb1-dev \
            libx11-xcb-dev \
            flex \
            bison \
            zlib1g-dev \
            libexpat1-dev
        elif command -v yum &> /dev/null; then
          sudo yum install -y \
            meson \
            ninja-build \
            python3-pip \
            pkgconfig \
            gcc \
            gcc-c++ \
            libdrm-devel \
            libX11-devel \
            flex \
            bison
        fi

    - name: Clone Mesa source
      run: |
        git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git
        cd mesa
        echo "Mesa version: $(git describe --tags || git rev-parse --short HEAD)"

    - name: Configure Mesa for Adreno 725 (Native)
      run: |
        cd mesa
        meson setup builddir \
          -Dprefix=/usr/local \
          -Dgallium-drivers=freedreno,softpipe \
          -Dvulkan-drivers=freedreno \
          -Dfreedreno-kmd=kgsl \
          -Dglx=disabled \
          -Degl=enabled \
          -Dgbm=enabled \
          -Dgles1=enabled \
          -Dgles2=enabled \
          -Dplatforms=surfaceless \
          -Dbuildtype=release \
          -Db_lto=true \
          -Dstrip=true \
          -Dshared-glapi=enabled \
          -Dllvm=disabled \
          -Dvalgrind=disabled

    - name: Build Mesa
      run: |
        cd mesa
        echo "Starting native build on $(uname -m)..."
        ninja -C builddir -j$(nproc)
        echo "Native build completed!"

    - name: Test libraries (optional)
      run: |
        cd mesa
        echo "Generated libraries:"
        find builddir -name "*.so*" | head -10

    - name: Create package
      run: |
        cd mesa
        mkdir -p ../mesa-native-package/{lib,share}
        
        # 复制库文件
        find builddir -name "*.so*" -exec cp {} ../mesa-native-package/lib/ \;
        
        # 创建版本信息
        echo "# Mesa for Adreno 725 (Native Build)" > ../mesa-native-package/README.md
        echo "Built on: $(date)" >> ../mesa-native-package/README.md
        echo "Architecture: $(uname -m)" >> ../mesa-native-package/README.md
        echo "Mesa commit: $(git rev-parse HEAD)" >> ../mesa-native-package/README.md

    - name: Create release archive
      run: |
        tar -czf mesa-adreno725-native-$(uname -m).tar.gz mesa-native-package
        zip -r mesa-adreno725-native-$(uname -m).zip mesa-native-package

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mesa-adreno725-native-build
        path: |
          mesa-adreno725-native-*.tar.gz
          mesa-adreno725-native-*.zip

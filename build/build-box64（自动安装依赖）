#!/bin/bash

#作者:@纆泽@deepseek
#!/bin/bash

check_dependencies() {
    echo -e "\033[1;36m▶ 开始安装必要依赖(卡住请科学上网)\033[0m"
    sleep 2
    
    pkg i glibc-repo -y && \
    pkg install -y glibc git-glibc wget-glibc cmake-glibc \
    python-glibc gcc-glibc build-essential cmake ninja git || {
        echo -e "\n\033[1;31m✗ 依赖安装失败！\033[0m"
        exit 1
    }
    
    echo -e "\n\033[1;32m✓ 所有依赖安装完成\033[0m"
    sleep 1
    clear
}

show_notice() {
    echo ""
    echo "=================================================="
    echo "注意事项："
    echo "在编译过程中如果在克隆阶段有失败或卡住等问题，请使用科学上网以确保连接github库"
    echo "=================================================="
    echo ""
}

# 获取当前box64版本
get_box64_version() {
    if command -v box64 >/dev/null 2>&1; then
        box64 --version 2>/dev/null | head -n1 || echo "未知版本"
    else
        echo "未安装"
    fi
}

main_menu() {
    clear
    echo "======================================"
    echo "       Box64 编译工具 v2.1"
    echo "======================================"
    echo "1. 编译最新版本"
    echo "2. 编译指定版本"
    echo "0. 退出脚本"
    echo "======================================"
    
    # 显示当前box64版本区域
    echo ""
    echo "══════════════════════════════════════"
    echo "        当前 Box64 版本信息"
    echo "══════════════════════════════════════"
    echo "版本: $(get_box64_version)"
    echo "══════════════════════════════════════"
    echo ""
    
    show_notice
}

config_menu() {
    clear
    echo "======================================"
    echo "       请选择编译配置"
    echo "======================================"
    echo "1. 配置一 (完整优化)"
    echo "2. 配置二 (中等优化)"
    echo "3. 配置三 (基础配置)"
    echo "4. 配置四 (最小配置)"
    echo "5. 自定义配置"
    echo "0. 返回主菜单"
    echo "======================================"
}

check_directory() {
    if [ -d ~/box64 ]; then
        read -p "检测到存在的box64目录，是否删除？[y/N] " choice
        if [[ $choice =~ [yY] ]]; then
            rm -rf ~/box64 || return 1
        else
            echo "操作已取消，请手动处理目录后重试"
            exit 1
        fi
    fi
}

run_build() {
    local config=$1
    local version=$2
    
    if [ -z "$version" ]; then
        git clone https://github.com/ptitSeb/box64 ~/box64 || {
            echo "仓库克隆失败！请检查网络连接"
            exit 1
        }
    else
        git clone --branch "$version" https://github.com/ptitSeb/box64 ~/box64 || {
            echo "指定版本下载失败！请检查版本号"
            exit 1
        }
    fi

    sed -i "s/usr/usr\/glibc/g" ~/box64/CMakeLists.txt

    case $config in
        1)
            cd ~/box64 && mkdir build && cd build
            cmake .. -DARM_DYNAREC=ON -DCMAKE_BUILD_TYPE=Release \
              -DBAD_SIGNAL=ON -DARM64=ON -DSAVE_MEM=ON -DNOGIT=OFF \
              -DNOLOADADDR=OFF -DWITH_MOLD=OFF -DBOX32=OFF \
              -DBOX32_BINFMT=OFF -DTERMUX=ON \
              -DSD845=1 -DSD888=1 -DSD8G2=1
            ;;
        2)
            cd ~/box64 && mkdir build && cd build
            cmake .. -DARM_DYNAREC=ON -DCMAKE_BUILD_TYPE=Release \
              -DBAD_SIGNAL=ON -DARM64=ON -DNOLOADADDR=ON \
              -DTERMUX=ON -DSD845=1 -DSD888=1 -DSD8G2=1
            ;;
        3)
            cd ~/box64 && mkdir build && cd build
            cmake .. -DTERMUX=ON -DSD845=1 -DSD888=1 -DSD8G2=1
            ;;
        4)
            cd ~/box64 && mkdir build && cd build
            cmake .. -DTERMUX=ON
            ;;
        5)
            cd ~/box64 && mkdir build && cd build
            echo -e "\n\033[1;32m✓ 已进入构建目录：$(pwd)\033[0m"
            echo "========================================"
            echo "请手动输入编译配置命令（示例）："
            echo "cmake .. -DTERMUX=ON -DARM64=ON"
            echo
            echo "后续操作指引："
            echo "1. 编译命令：make -j$(nproc)"
            echo "2. 安装命令：make install"
            echo "3. 清理命令：rm -rf ~/box64"
            echo "========================================"
            exit 0
            ;;
        *)
            echo "无效配置选择"
            exit 1
            ;;
    esac

    make -j8
    read -p "编译完成，是否安装？[y/N] " choice
    if [[ $choice =~ [yY] ]]; then
        make install
        echo "✓ 安装完成"
    fi

    read -p "是否删除编译目录？[Y/n] " choice
    if [[ ! $choice =~ [nN] ]]; then
        rm -rf ~/box64
    fi
}

check_dependencies

while true; do
    main_menu
    read -p "请输入选项：" choice
    case $choice in
        1) 
            check_directory
            config_menu
            read -p "请输入配置选择：" config
            case $config in
                0) ;;
                [1-5]) run_build $config ;;
                *) echo "无效选择" ;;
            esac
            ;;
        2)
            check_directory
            echo "正在获取版本列表..."
            tags=$(git ls-remote --tags https://github.com/ptitSeb/box64 | \
                   awk -F/ '{print $3}' | sort -Vr)
            tags="$tags 返回主菜单"
            PS3="请选择版本 (输入数字): "
            select tag in $tags; do
                if [ "$tag" == "返回主菜单" ]; then
                    echo "正在返回主菜单..."
                    sleep 1
                    break
                elif [ -n "$tag" ]; then
                    break
                else
                    echo "无效选择，请重新输入"
                fi
            done
            if [ "$tag" == "返回主菜单" ]; then
                continue
            fi
            config_menu
            read -p "请输入配置选择：" config
            case $config in
                0) ;;
                [1-5]) run_build $config $tag ;;
                *) echo "无效选择" ;;
            esac
            ;;
        0) 
            echo "脚本退出"
            exit 0
            ;;
        *) echo "无效选项" ;;
    esac
    read -p "按回车键继续..."
done
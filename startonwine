#!/data/data/com.termux/files/usr/bin/bash
# 作者:@咔咔龙@zhongerxll@kakadragonn
# 版本:2.4

export LC_ALL="$(cat /data/data/com.termux/files/usr/glibc/opt/locale.conf)" >/dev/null 2>&1

show_error(){
	eval "local cmd=($2)"
	kill $zenity_pid 2>/dev/null
	echo "$1">&2
	zenity --error --text="$1" ${cmd[@]} 2>/dev/null
	usage
	exit
}
show_info(){
	eval "local cmd=($2)"
	kill $zenity_pid 2>/dev/null
	echo "$1"
	zenity --info --text="$1" ${cmd[@]} 2>/dev/null &
	zenity_pid=$!
}
# Java进度条显示函数
show_progress_java() {
    local title="$1"
    {
        # 原有的进度输出逻辑保持不变
        echo12(){
            echo "$@" | tee >(cat >&2)
        }
        echo12 "# Configuring $WINEPREFIX. This may take a few minutes"
        rm -rf $WINEPREFIX
        unset BOX64_DYNAREC_BIGBLOCK
        unset WINEESYNC
        unset WINEESYNC_TERMUX
        unset BOX64_DYNAREC_CALLRET
        if [ -e $WINE_PATH/lib/wine/i386-windows/shell32-bak.dll ] || [ -e $WINE_PATH/lib64/wine/x86_64-windows/shell32-bak.dll ]; then
            mv $WINE_PATH/lib/wine/i386-windows/shell32-bak.dll $WINE_PATH/lib/wine/i386-windows/shell32.dll &>/dev/null
            mv $WINE_PATH/lib/wine/x86_64-windows/shell32-bak.dll $WINE_PATH/lib/wine/x86_64-windows/shell32.dll &>/dev/null
            mv $WINE_PATH/lib64/wine/x86_64-windows/shell32-bak.dll $WINE_PATH/lib64/wine/x86_64-windows/shell32.dll &>/dev/null
            mv $WINE_PATH/lib64/wine/i386-windows/shell32-bak.dll $WINE_PATH/lib64/wine/i386-windows/shell32.dll &>/dev/null
        fi
        echo "10|初始化WINE环境..."
        
        WINEDLLOVERRIDES="mscoree=disabled" ${taskset[@]} $RUN_CMD wineboot -u >${LOG_PATH}_wineboot.txt 2>&1
        if [ ! -e $WINEPREFIX/.update-timestamp ]; then
            echo "100|错误: 无法配置WINE环境"
            show_error "Cannot configure. See ${LOG_PATH}_wineboot.txt"
            box64 wineserver -k
            echo "CLOSE"
            exit
        fi
        echo "40|解压系统文件..."
        
        7z x $PREFIX/glibc/opt/prefix/drive_c.7z -o$WINEPREFIX/drive_c -y >>${LOG_PATH}_wineboot.txt 2>&1
        7z x $PREFIX/glibc/opt/prefix/drive_c1.7z -o$WINEPREFIX/drive_c -y >>${LOG_PATH}_wineboot.txt 2>&1
        echo12 "# Installing DirectX"
        echo "45|安装DirectX..."
        
        7z x $PREFIX/glibc/opt/prefix/directx.7z -o$WINEPREFIX/drive_c -y >>${LOG_PATH}_wineboot.txt 2>&1
        echo12 "# Installing Start Menu shortcuts"
        echo "50|安装开始菜单快捷方式..."
        
        cp -r $PREFIX/glibc/opt/prefix/start/* "$WINEPREFIX/drive_c/ProgramData/Microsoft/Windows/Start Menu"
        rm -rf "$WINEPREFIX/dosdevices/z:"
        ln -sf /data/data/com.termux/files "$WINEPREFIX/dosdevices/z:"
        ln -sf /sdcard/Download "$WINEPREFIX/dosdevices/d:"
        ln -sf /sdcard/Android/data/com.termux/files/ "$WINEPREFIX/dosdevices/e:"
        echo12 "# Installing registry tweaks"
        echo "60|安装注册表调整..."
        
        cp $PREFIX/glibc/opt/prefix/marlett.ttf $WINEPREFIX/drive_c/windows/Fonts
        ${taskset[@]} $RUN_CMD regedit $PREFIX/glibc/opt/prefix/user.reg >>${LOG_PATH}_wineboot.txt 2>&1
        ${taskset[@]} $RUN_CMD regedit $PREFIX/glibc/opt/prefix/system.reg >>${LOG_PATH}_wineboot.txt 2>&1
        ${taskset[@]} $RUN_CMD regedit $PREFIX/glibc/opt/prefix/change.reg >>${LOG_PATH}_wineboot.txt 2>&1
        ${taskset[@]} $RUN_CMD regedit $PREFIX/glibc/opt/prefix/fix-services.reg >>${LOG_PATH}_wineboot.txt 2>&1
        tar -xf $PREFIX/glibc/opt/prefix/fix-fonts.tar.xz -C $WINEPREFIX/drive_c/windows
        if [ ! "$STARTUP_COMPATIBILITY_MODE" = "1" ]; then
            echo12 "# Installing PhysX 9.10, 7-Zip, Visual C++ Redistributable"
            echo "70|安装运行库(PhysX, VC++等)..."
            
            ${taskset[@]} $RUN_CMD explorer /desktop=shell,640x480 start /unix $PREFIX/glibc/opt/apps/install.bat >${LOG_PATH}_redist.txt 2>&1
            box64 wineserver -k
            if [ ! -e $PREFIX/glibc/opt/virgl/virgl-enabled ]; then
                echo12 "# Installing dxvk-async-1.10.3"
                echo "80|安装DXVK图形驱动..."
                
                ${taskset[@]} $RUN_CMD explorer /desktop=shell,640x480 start /unix $PREFIX/glibc/opt/prefix/d3d/dxvk-async-1.10.3.bat >>${LOG_PATH}_wineboot.txt 2>&1
                echo12 "# Installing turnip-v6.5"
                echo "85|安装Turnip驱动..."
                
                box64 wineserver -k
                ${taskset[@]} $RUN_CMD explorer /desktop=shell,640x480 start /unix $PREFIX/glibc/opt/prefix/mesa/turnip-v6.5.bat >>${LOG_PATH}_wineboot.txt 2>&1
            else
                echo12 "# Installing wined3d-8.0.2"
                echo "90|安装WineD3D..."
                
                ${taskset[@]} $RUN_CMD explorer /desktop=shell,640x480 start /unix $PREFIX/glibc/opt/prefix/d3d/wined3d-8.0.2.bat >>${LOG_PATH}_wineboot.txt 2>&1
            fi
        fi
        echo12 "# wine prefix 构建完成！"
        echo "99|WINE环境构建完成!"
        box64 wineserver -k
        echo "disable">$WINEPREFIX/.update-timestamp
        echo "100|完成!"
        echo "CLOSE"
        
    } | java -cp /data/data/com.termux/files/home/usr/bin ProgressBar "构建更新wine prefix"
}

usage(){
	echo 'v2.4

Usage: startonwine [OPTION]... [FILEPATH]...

 -d,--desktop
  使用虚拟桌面打开，参数可选，必须紧贴选项，默认参数为800x600。
   例: 启动默认的800x600分辨率的虚拟桌面并启动/path/example.exe
	startonwine -d "/path/example.exe"
 -w,--wow64
  禁用box86。
   例: 启动1280x720p的虚拟桌面并禁用box86并启动/path/example.exe
	startonwine -d1280x720 "/path/example.exe" -w
 -a,--args
  传入给wine的参数，可以传入多个，在需要传递选项的时候可以用
   例1: 输出当前wine版本，以下两个命令效果一致
	startonwine -a--version --debug
	startonwine --args=--version --debug
   例2: 启动1280x720p的虚拟桌面并尝试使用box86并启动/path/example.exe
	startonwine -aeplorer -a/desktop=shell,1280x720 -a"/path/example.exe"
  在不需要传递选项时可以不使用--args
   例: 启动1280x720p的虚拟桌面并尝试使用box86并启动/path/example.exe
	startonwine eplorer /desktop=shell,1280x720 "/path/example.exe"
 --debug
  打印wine的日志到标准输出，默认仅打印到/sdcard/mobox_log.txt
 -b,--ib
  顺便启动ib
 -5,--f5taskmgr
  顺便启动f5taskmgr
 -h,--help
  显示这个使用帮助。
'
}
if [ -z "$DISPLAY" ]; then
	export DISPLAY=:0
fi
. $PREFIX/glibc/opt/scripts/configs
load_configs
unset LD_PRELOAD
export PATH=$PREFIX/glibc/bin:$PATH
export GLIBC_BIN=$PREFIX/glibc/bin
export BOX64_PATH=$GLIBC_BIN
export BOX86_PATH=$BOX64_PATH
export BOX64_LD_LIBRARY_PATH=$WINEPATH/lib/wine/i386-unix:$WINEPATH/lib/wine/x86_64-unix
export BOX86_LD_LIBRARY_PATH=$BOX64_LD_LIBRARY_PATH
out="&>/dev/null"
eval "set -- $(getopt -o d::a:hwb5 --long desktop::,args:,help,debug,wow64,ib,f5taskmgr -- "$@")"
while :; do
	case "$1" in
		-d|--desktop)
			if [ -z "$2" ]; then
				resolution=(explorer /desktop=shell,800x600)
			else
				if ! [[ "$2" =~ ^[0-9]+x[0-9]+$ ]]; then
					show_error "分辨率格式错误！">&2
					exit 1
				fi
				resolution=(explorer /desktop=shell,$2)
			fi
			shift
		;;
		-a|--args)
			wine_args+=( "$2" )
			shift
		;;
		-h|--help)
			usage
			exit
		;;
		--debug)
			out=
		;;
		-w|--wow64)
			wow64=1
			if ! (box64 -f | grep MMAP);then
				echo "检测到box64版本过旧，可能无法使用wow64运行vulkan"
				zenity --warning --text="检测到box64版本过旧，可能无法使用wow64运行vulkan" --timeout 3 &
			fi
		;;
		-b|--ib)
			startib=1
		;;
		-5|--f5taskmgr)
			f5taskmgr=1
		;;
		--)
			shift
			break
		;;
		*)
			show_error "$1 不是一个选项。" 
			usage
		;;
	esac
	shift
done
if [ "$#" -lt 1 ] && [ -z "${wine_args[*]}" ] ; then
	set -- "$(zenity --file-selection --filename=/sdcard/)"
fi
if [ -f "$*" ]; then
	eval "set -- start /unix '$(realpath "$*")'"
fi
if [ -d $WINE_PATH/lib/wine/i386-unix ]; then
    rm -rf $PREFIX/glibc/bin/{wine,wine64,wineserver}
    ln -sf $WINE_PATH/bin/wine $PREFIX/glibc/bin/wine
    ln -sf $WINE_PATH/bin/wine64 $PREFIX/glibc/bin/wine64
ln -sf $WINE_PATH/bin/wineserver $PREFIX/glibc/bin/wineserver
	RUN_CMD="$GLIBC_BIN/box64 $GLIBC_BIN/wine64"
	if [ $wow64 ]; then
		mv -f $PREFIX/glibc/bin/box86 $PREFIX/glibc/bin/box86b 2>/dev/null
	else
		mv -f $PREFIX/glibc/bin/box86b $PREFIX/glibc/bin/box86 2>/dev/null
		patchelf --force-rpath --set-rpath $PREFIX/glibc/lib32 --set-interpreter $PREFIX/glibc/lib32/ld-linux-armhf.so.3 $PREFIX/glibc/bin/box86 2>/dev/null
	fi
else
    rm -rf $PREFIX/glibc/bin/{wine,wineserver}
    ln -sf $WINE_PATH/bin/wine $PREFIX/glibc/bin/wine
    ln -sf $WINE_PATH/bin/wineserver $PREFIX/glibc/bin/wineserver
	RUN_CMD="$GLIBC_BIN/box64 $GLIBC_BIN/wine"
fi
patchelf --force-rpath --set-rpath $PREFIX/glibc/lib --set-interpreter $PREFIX/glibc/lib/ld-linux-aarch64.so.1 $PREFIX/glibc/bin/box64 2>/dev/null
if [ -e $PREFIX/glibc/opt/virgl/virgl-enabled ] && ! pgrep -f libvirgl_test_server.so>/dev/null; then
	$PREFIX/glibc/opt/virgl/libvirgl_test_server.so &>/dev/null &
fi
if ! pgrep -x pulseaudio>/dev/null; then
	pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
fi
taskset -c $PRIMARY_CORES true 2>/dev/null && taskset=(taskset -c $PRIMARY_CORES) || zenity --warning --text="调用**$PRIMARY_CORES** cpu核心失败！可能导致的原因是termux在后台！请尝试进入设置修改termux的电池后台运行相关权限！或者将termux变为小窗！如果依旧弹出该警告可进q群615083160咨询！操作将继续，但cpu核心将由系统自动分配，性能也许会降低" --timeout 3
if [ "$(cat $WINEPREFIX/.update-timestamp 2>/dev/null)" != "disable" ]; then
	show_progress_java "构建更新wine prefix"
fi
kill $zenity_pid 2>/dev/null
if [ -n "$startib" ]; then
	eval "LC_ALL='$(cat $PREFIX/glibc/opt/locale.conf)' ${taskset[@]} $RUN_CMD ${resolution[@]} '$PREFIX/glibc/bin/ib.exe' $out &"
fi
if [ -n "$f5taskmgr" ] && pgrep f5taskmgr.exe 1>/dev/null; then
	eval "LC_ALL='$(cat $PREFIX/glibc/opt/locale.conf)' ${taskset[@]} $RUN_CMD ${resolution[@]} '$PREFIX/glibc/opt/apps/f5taskmgr.exe' $out &"
fi
export PULSE_SERVER=127.0.0.1
LC_ALL="$(cat $PREFIX/glibc/opt/locale.conf)" ${taskset[@]} $RUN_CMD ${wine_args[@]} ${resolution[@]}  "$@" 2>&1 | eval "tee $LOG_PATH $out"